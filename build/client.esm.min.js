/*!
 * tiny-msg-client - version 0.6.0
 *
 * Made with ‚ù§ by Steve Ottoz so@dev.so
 *
 * Copyright (c) 2020 Steve Ottoz
 */
export default class Msg{constructor(a,b=""){this.url=b,this.channel=a,this.handler={},this.q=[],this.init()}init(){return WebSocket?(this.ws=new WebSocket(this.url,this.channel),this.ws.onopen=this._onopen.bind(this),this.ws.onmessage=this._onmessage.bind(this),this.ws.onerror=this._onerror.bind(this),this.ws.onclose=this._onclose.bind(this),this):void(this.ws={readyState:0})}send(a){try{a=JSON.stringify(a)}catch(a){}if(1===this.ws.readyState)try{this.ws.send(a)}catch(b){this.q.push(a)}else this.q.push(a);return this}on(a,b){return Array.isArray(this.handler[a])||(this.handler[a]=[]),this.handler[a].push(b),this}_onopen(){for(;this.q.length;)try{this.ws.send(this.q.shift())}catch(a){}}_onmessage(a){let b=a.data;try{b=JSON.parse(b)}catch(a){}if(Array.isArray(this.handler.message))for(let c of this.handler.message)/^f/.test(typeof c)&&c.apply(this,[a,b,this])}_onerror(a){if(Array.isArray(this.handler.error))for(let b of this.handler.error)/^f/.test(typeof b)&&b.apply(this,[a,this])}_onclose(){clearTimeout(this.timeout),this.timeout=setTimeout(this.init.bind(this),5e3)}}